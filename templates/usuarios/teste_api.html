{% extends "base.html" %}
{% block title %}Teste da API{% endblock %}
{% block content %}
  <h2>Teste de Conexão — {{ exchange|capitalize }}</h2>
  {% if result.ok %}
    <div class="alert alert-success">Conectado! ✅</div>
    <p>
      <strong>{{ symbol }}</strong> preço: <code>{{ price or '-' }}</code> •
      USDT livre: <code>{{ free_usdt or 0 }}</code>
    </p>

    <form method="post" action="{{ url_for('usuario_api.sugestao_ia') }}" class="row g-2 align-items-end mb-3">
      <div class="col-auto">
        <label class="form-label">Símbolo</label>
        <input class="form-control" name="symbol" value="{{ symbol or 'BTCUSDT' }}">
      </div>
      <div class="col-auto">
        <label class="form-label">Risco</label>
        <select class="form-select" name="risco">
          <option value="conservador">Conservador</option>
          <option value="moderado">Moderado</option>
          <option value="arrojado">Arrojado</option>
        </select>
      </div>
      <div class="col-auto">
        <button class="btn btn-info">Sugerir com IA</button>
      </div>
    </form>

    {% if sug_text %}
      <div class="alert alert-primary"><strong>IA:</strong> {{ sug_text }}</div>
    {% endif %}

    <form method="post" action="{{ url_for('usuario_api.ordem_enviar') }}" class="row g-2 align-items-end">
      <div class="col-auto">
        <label class="form-label">Símbolo</label>
        <input class="form-control" name="symbol" value="{{ symbol or 'BTCUSDT' }}">
      </div>
      <div class="col-auto">
        <label class="form-label">Side</label>
        <select class="form-select" name="side">
          <option value="BUY">BUY</option>
          <option value="SELL">SELL</option>
        </select>
      </div>
      <div class="col-auto">
        <label class="form-label">Tipo</label>
        <select class="form-select" name="tipo" id="tipo">
          <option value="MARKET">MARKET</option>
          <option value="LIMIT">LIMIT (GTC)</option>
          <option value="STOP_LOSS_LIMIT">STOP LOSS LIMIT</option>
          <option value="TAKE_PROFIT_LIMIT">TAKE PROFIT LIMIT</option>
          <option value="OCO">OCO (alvo + stop)</option>
        </select>
      </div>
      <div class="col-auto" id="priceWrap" style="display:none;">
        <label class="form-label">Preço (LIMIT/TP)</label>
        <input class="form-control" name="price" value="{{ price or '' }}">
      </div>
      <div class="col-auto" id="stopWrap" style="display:none%">
        <label class="form-label">Stop Price (SL/TP/OCO)</label>
        <input class="form-control" name="stop_price" value="">
      </div>
      <div class="col-auto" id="stopLimitWrap" style="display:none;">
        <label class="form-label">Stop Limit Price (OCO/SL)</label>
        <input class="form-control" name="stop_limit_price" value="">
      </div>
      <div class="col-auto">
        <label class="form-label">Qtd</label>
        <input class="form-control" name="qty" value="{{ sug_qty or '0.001' }}">
      </div>
      <div class="col-auto">
        <button class="btn btn-warning">Enviar ordem</button>
      </div>
    </form>

    <script>
      const tipo = document.getElementById('tipo');
      const priceWrap = document.getElementById('priceWrap');
      const stopWrap = document.getElementById('stopWrap');
      const stopLimitWrap = document.getElementById('stopLimitWrap');
      function toggleFields(){
        const t = tipo.value;
        priceWrap.style.display = (t === 'LIMIT' || t === 'TAKE_PROFIT_LIMIT' || t === 'OCO') ? '' : 'none';
        stopWrap.style.display = (t === 'STOP_LOSS_LIMIT' || t === 'TAKE_PROFIT_LIMIT' || t === 'OCO') ? '' : 'none';
        stopLimitWrap.style.display = (t === 'STOP_LOSS_LIMIT' || t === 'OCO') ? '' : 'none';
      }
      tipo.addEventListener('change', toggleFields); toggleFields();
    </script>

  {% else %}
    <div class="alert alert-danger">Falha: {{ result.error }}</div>
    <a class="btn btn-secondary" href="{{ url_for('usuario_api.configurar_api') }}">Voltar</a>
  {% endif %}
{% endblock %}